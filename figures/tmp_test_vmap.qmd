```{python}
import os

# Force JAX to use CPU - must be set before ANY JAX imports
# os.environ['XLA_FLAGS'] = '--xla_force_host_platform_device_count=48'
os.environ['JAX_PLATFORM_NAME'] = 'gpu'
# os.environ['CUDA_VISIBLE_DEVICES'] = ''  # Hide GPUs from JAX

%config InlineBackend.figure_formats = ['svg']

import numpy as np
import matplotlib.pyplot as plt
import jax

from bicytok.imports import importCITE, sample_receptor_abundances
from bicytok.selectivity_funcs import optimize_affs_parallel

import time

print(f"JAX platform: {jax.default_backend()}")
print(f"Number of devices: {len(jax.devices())}")
print(f"Device types: {[device.device_kind for device in jax.devices()]}")

receptors = ["CD25", "CD4-1", "CD27"]
signal = ["CD122"]
cell_type = "Treg"
dose = 1e-10
valency = np.array([[2, 1, 1]])
cell_categorization = "CellType2"
sample_size = 100

CITE_DF = importCITE()

epitopes = [
    col
    for col in CITE_DF.columns
    if col not in ["CellType1", "CellType2", "CellType3"]
]
epitopes_df = CITE_DF[epitopes + [cell_categorization]]
epitopes_df = epitopes_df.rename(columns={cell_categorization: "Cell Type"})
sample_df = sample_receptor_abundances(epitopes_df, sample_size, cell_type)

targ_mask = (sample_df["Cell Type"] == cell_type).to_numpy()
off_targ_mask = ~targ_mask

signal_abun = sample_df[signal].to_numpy()

selectivities = np.full((len(receptors), len(receptors)), np.nan)
row, col = np.tril_indices(len(receptors), k=0)

targ_rec_stack = []
off_targ_rec_stack = []
dose_stack = []
valency_stack = []

time_start = time.time()
for i, j in zip(row, col, strict=False):
    rec1 = receptors[i]
    rec2 = receptors[j]

    rec1_abun = sample_df[[rec1]].to_numpy()
    rec2_abun = sample_df[[rec2]].to_numpy()

    receptor_abuns = np.hstack((signal_abun, rec1_abun, rec2_abun))

    targ_abun = receptor_abuns[targ_mask]
    off_targ_abun = receptor_abuns[off_targ_mask]

    targ_rec_stack.append(targ_abun)
    off_targ_rec_stack.append(off_targ_abun)
    dose_stack.append(dose)
    valency_stack.append(valency)

# Convert lists to numpy arrays with proper shapes
targ_rec_stack = np.array(targ_rec_stack)  # (problems, target_cells, receptors)
off_targ_rec_stack = np.array(off_targ_rec_stack)  # (problems, off_target_cells, receptors)
dose_stack = np.array(dose_stack)  # (problems,)
valency_stack = np.array(valency_stack)  # (problems, receptors)

print(f"Target receptor stack shape: {targ_rec_stack.shape}")
print(f"Off-target receptor stack shape: {off_targ_rec_stack.shape}")
print(f"Dose stack shape: {dose_stack.shape}")
print(f"Valency stack shape: {valency_stack.shape}")

print(targ_rec_stack)
print(off_targ_rec_stack)
print(dose_stack)
print(valency_stack)

# Run parallel optimization
opt_selec, opt_affs, opt_kx_star = optimize_affs_parallel(
    targ_rec_stack, 
    off_targ_rec_stack, 
    dose_stack, 
    valency_stack
)

time_end = time.time()
print(f"Optimization completed in {time_end - time_start:.2f} seconds.")

print(f"Optimized selectivities: {opt_selec}")
print(f"Optimized affinities shape: {opt_affs.shape}")
print(f"Optimized Kx_star values: {opt_kx_star}")
```