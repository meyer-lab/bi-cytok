---
title: "Valency Composition Scan"
---

# Summary
This analysis calculates selectivity across varying compositions of binding subunits for fixed total valencies. The first receptor is the signaling subunit, and the remaining two receptors are binding targets. Results are displayed in a single comprehensive heatmap.

# Imports
- CITE-seq surface marker expression data (`importCITE`)
- Selectivity optimization functions (`optimize_affs`)

# Parameters
- `sample_size`: Integer number of cells sampled from CITE-seq data for analysis
- `targ_cell`: String identifier for target cell type in selectivity optimization
- `dose`: Float concentration of ligand complex in binding model
- `cell_categorization`: String column name for cell type classification in CITE-seq data
- `receptors`: List of 3 strings naming receptors [signal_receptor, binding_target_1, binding_target_2]
- `fixed_valencies`: List of total valencies to test (e.g., [3, 4, 5, 6])
- `signal_valency`: Integer number of signaling receptor subunits (fixed for all compositions)

# Outputs
- **Heatmap**: Single comprehensive heatmap showing selectivity values for all compositions across all valencies
- **Printed Output**: Processing time and summary statistics

## Calculate Selectivity for All Compositions

```{python}
%config InlineBackend.figure_formats = ['svg']

import time

import numpy as np
import pandas as pd

from bicytok.imports import (
    filter_receptor_abundances,
    importCITE,
    sample_receptor_abundances,
)
from bicytok.selectivity_funcs import optimize_affs

sample_size = 1000
targ_cell = "Treg"
dose = 1e-10
cell_categorization = "CellType2"
receptors = ["CD122", "CD25", "CD4-1"]
signal_valency = 2
max_valency = 8

fixed_valencies = range(signal_valency, max_valency + 1)

CITE_DF = importCITE()

assert targ_cell in CITE_DF[cell_categorization].unique()
assert len(receptors) == 3, (
    "Must specify exactly 3 receptors: [signal, target1, target2]"
)

signal_receptor = receptors[0]
target_receptor_1 = receptors[1]
target_receptor_2 = receptors[2]

epitopes = [
    col for col in CITE_DF.columns if col not in ["CellType1", "CellType2", "CellType3"]
]
epitopes_df = CITE_DF[epitopes + [cell_categorization]]
epitopes_df = epitopes_df.rename(columns={cell_categorization: "Cell Type"})
sample_df = sample_receptor_abundances(
    CITE_DF=epitopes_df,
    numCells=min(sample_size, epitopes_df.shape[0]),
    targCellType=targ_cell,
    insert_mock_signal_rec=True,
)
filtered_sample_df = filter_receptor_abundances(
    sample_df, targ_cell, whitelist=receptors
)

on_target_mask = (filtered_sample_df["Cell Type"] == targ_cell).to_numpy()
off_target_mask = ~on_target_mask

df_targ_cell = filtered_sample_df.loc[on_target_mask]
df_off_targ_cell = filtered_sample_df.loc[off_target_mask]

targ_recs = df_targ_cell[receptors].to_numpy()
off_targ_recs = df_off_targ_cell[receptors].to_numpy()

results = []
time_start = time.time()

for total_valency in fixed_valencies:
    print(f"Calculating selectivity for total valency {total_valency}...")
    
    for n_target1 in range(total_valency - signal_valency + 1):
        n_target2 = total_valency - signal_valency - n_target1
        
        if n_target2 < 0:
            continue
        
        model_valencies = np.array([[signal_valency, n_target1, n_target2]])
        
        opt_selec, opt_affs, opt_kx_star = optimize_affs(
            targRecs=targ_recs,
            offTargRecs=off_targ_recs,
            dose=dose,
            valencies=model_valencies,
            init_vals=init_mod,
            Kx_star_bounds=(-15, -5),
        )
        selectivity = 1 / opt_selec
        
        print(f"(Signal: {signal_valency}, Target1: {n_target1}, Target2: {n_target2})")
        print(
            f"Affinities: {opt_affs}, Kx*: {opt_kx_star:.2e}, Selectivity: {selectivity:.4f}\n"
        )

        results.append(
            {
                "Total_Valency": total_valency,
            signal_receptor: signal_valency,
            target_receptor_1: n_target1,
            target_receptor_2: n_target2,
                "Selectivity": selectivity,
            }
        )

time_end = time.time()
print(f"\nTotal processing time: {time_end - time_start:.2f} seconds")
print(f"Calculated selectivity for {len(results)} different compositions")

results_df = pd.DataFrame(results)
print(
    f"\nSelectivity range: {results_df['Selectivity'].min():.2f} - {results_df['Selectivity'].max():.2f}"
)
print(f"Mean selectivity: {results_df['Selectivity'].mean():.2f}")
```


## Line Plot by Valency
```{python}
%config InlineBackend.figure_formats = ['svg']

import matplotlib.pyplot as plt

fig, ax = plt.subplots(figsize=(7, 5.5))

colors = plt.cm.viridis(np.linspace(0, 1, len(fixed_valencies)))

min_valency = min(fixed_valencies)

for idx, total_valency in enumerate(fixed_valencies):
    if total_valency == min_valency:
        continue
    
    subset_df = results_df[results_df["Total_Valency"] == total_valency].copy()
    
    if len(subset_df) == 0:
        continue
    
    binding_valency = total_valency - signal_valency
    
    if binding_valency == 0:
        subset_df["percentage"] = 0
    else:
        subset_df["percentage"] = (subset_df[target_receptor_1] / binding_valency) * 100
    
    subset_df = subset_df.sort_values(by="percentage")
    
    ax.plot(
        subset_df["percentage"],
        subset_df["Selectivity"],
        marker="o",
        linewidth=2,
        markersize=8,
        label=f"Valency {total_valency}",
        color=colors[idx],
    )

signal_only_df = results_df[results_df["Total_Valency"] == min_valency]
if len(signal_only_df) > 0:
    signal_only_selectivity = signal_only_df["Selectivity"].iloc[0]
    # ax.axhline(y=signal_only_selectivity, color='red', linestyle='--', linewidth=2, 
    #            label=f'Signal only baseline (V={min_valency})', alpha=0.7)

ax.set_xlabel(
    f"Percentage of binding subunits that are {target_receptor_1}\n(100% - {target_receptor_2})",
    fontsize=14,
)
ax.set_ylabel("Selectivity", fontsize=14)
ax.set_title(
    f"Selectivity vs Receptor Composition\n(Signal Valency of {signal_receptor} = {signal_valency})",
    fontsize=16,
    fontweight="bold",
    pad=20,
)
ax.legend(fontsize=11, loc="best")
ax.grid(True, alpha=0.3)
ax.set_xlim(-5, 105)

plt.tight_layout()
plt.show()
```


## Heatmap
```{python}
max_target1 = results_df[target_receptor_1].max()
max_target2 = results_df[target_receptor_2].max()

heatmap_data = np.full((int(max_target2) + 1, int(max_target1) + 1), np.nan)

for _, row in results_df.iterrows():
    heatmap_data[int(row[target_receptor_2]), int(row[target_receptor_1])] = row[
        "Selectivity"
    ]

fig, ax = plt.subplots(figsize=(6, 6))

im = ax.imshow(
    heatmap_data, cmap="viridis", aspect="auto", origin="lower", interpolation="nearest"
)

ax.set_xlabel(f"Number of {target_receptor_1} subunits", fontsize=14)
ax.set_ylabel(f"Number of {target_receptor_2} subunits", fontsize=14)
ax.set_title(
    f"Selectivity Across Valency Compositions\n({signal_receptor} = {signal_valency})",
    fontsize=16,
    fontweight="bold",
    pad=20,
)

ax.set_xticks(range(int(max_target1) + 1))
ax.set_yticks(range(int(max_target2) + 1))

mask = np.isnan(heatmap_data)
vmin = np.nanmin(heatmap_data)
vmax = np.nanmax(heatmap_data)
vmid = (vmin + vmax) / 2

for i in range(int(max_target2) + 1):
    for j in range(int(max_target1) + 1):
        if not mask[i, j]:
            text_color = "white" if heatmap_data[i, j] < vmid else "black"
            
            total_val = signal_valency + j + i
            
            ax.text(
                j,
                i,
                f"{heatmap_data[i, j]:.3f}\n(V={total_val})",
                ha="center",
                va="center",
                color=text_color,
                fontsize=9,
                fontweight="bold",
            )

cbar = plt.colorbar(im, ax=ax, fraction=0.046, pad=0.04)
cbar.set_label("Selectivity", rotation=270, labelpad=20, fontsize=12)

plt.tight_layout()
plt.show()

print("\nResults table:")
print(results_df.to_string(index=False))
```